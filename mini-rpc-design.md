# Mini-RPC æ¡†æ¶ï¼šå®Œæ•´è®¾è®¡æ–‡æ¡£ä¸æ‰§è¡Œè®¡åˆ’

> **ä½œè€…**: Dennis (Boxuan) + Claude
> **ç›®æ ‡**: 25 å¤©å†…å®Œæˆ Mini-RPC + GoChatï¼ŒæŠ•é€’è…¾è®¯/å­—èŠ‚ Go åç«¯æ ¡æ‹›
> **æ—¥æœŸ**: 2026-02-06 ~ 2026-03-03ï¼ˆå…ƒå®µå‰ï¼‰

---

## ç›®å½•

1. [é¡¹ç›®å®šä½ä¸é¢è¯•ä»·å€¼](#1-é¡¹ç›®å®šä½ä¸é¢è¯•ä»·å€¼)
2. [æ•´ä½“æ¶æ„è®¾è®¡](#2-æ•´ä½“æ¶æ„è®¾è®¡)
3. [æ¨¡å—ä¸€ï¼šåè®®è®¾è®¡ï¼ˆProtocolï¼‰](#3-æ¨¡å—ä¸€åè®®è®¾è®¡protocol)
4. [æ¨¡å—äºŒï¼šåºåˆ—åŒ–ï¼ˆCodecï¼‰](#4-æ¨¡å—äºŒåºåˆ—åŒ–codec)
5. [æ¨¡å—ä¸‰ï¼šä¼ è¾“å±‚ï¼ˆTransportï¼‰](#5-æ¨¡å—ä¸‰ä¼ è¾“å±‚transport)
6. [æ¨¡å—å››ï¼šæœåŠ¡æ³¨å†Œä¸å‘ç°ï¼ˆRegistryï¼‰](#6-æ¨¡å—å››æœåŠ¡æ³¨å†Œä¸å‘ç°registry)
7. [æ¨¡å—äº”ï¼šè´Ÿè½½å‡è¡¡ï¼ˆLoad Balancerï¼‰](#7-æ¨¡å—äº”è´Ÿè½½å‡è¡¡load-balancer)
8. [æ¨¡å—å…­ï¼šä¸­é—´ä»¶é“¾ï¼ˆMiddlewareï¼‰](#8-æ¨¡å—å…­ä¸­é—´ä»¶é“¾middleware)
9. [Day-by-Day æ‰§è¡Œè®¡åˆ’](#9-day-by-day-æ‰§è¡Œè®¡åˆ’)
10. [é¡¹ç›®ç›®å½•ç»“æ„](#10-é¡¹ç›®ç›®å½•ç»“æ„)
11. [é¢è¯•é«˜é¢‘è¿½é—®ä¸å›ç­”è¦ç‚¹](#11-é¢è¯•é«˜é¢‘è¿½é—®ä¸å›ç­”è¦ç‚¹)
12. [Benchmark è®¡åˆ’](#12-benchmark-è®¡åˆ’)
13. [GoChat IM ç³»ç»Ÿè®¾è®¡ï¼ˆPhase 2ï¼‰](#13-gochat-im-ç³»ç»Ÿè®¾è®¡phase-2)
14. [ç®€å†æªè¾å»ºè®®](#14-ç®€å†æªè¾å»ºè®®)

---

## 1. é¡¹ç›®å®šä½ä¸é¢è¯•ä»·å€¼

### 1.1 ä¸€å¥è¯æè¿°

> Mini-RPC æ˜¯ä¸€ä¸ªä»é›¶å®ç°çš„è½»é‡çº§ Go RPC æ¡†æ¶ï¼Œæ”¯æŒè‡ªå®šä¹‰äºŒè¿›åˆ¶åè®®ã€è¿æ¥æ± å¤ç”¨ã€å¤šè·¯å¤ç”¨ã€
> æœåŠ¡æ³¨å†Œå‘ç°ï¼ˆetcdï¼‰ã€å¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥å’Œä¸­é—´ä»¶é“¾ï¼Œç”¨äºæ·±å…¥ç†è§£ RPC åº•å±‚åŸç†ã€‚

### 1.2 ä¸ºä»€ä¹ˆé¢è¯•å®˜ä¼šæ„Ÿå…´è¶£

- **å­—èŠ‚è‡ªç ” Kitex**ï¼ˆGo RPC æ¡†æ¶ï¼‰ï¼Œè…¾è®¯è‡ªç ” **tRPC**ã€‚ä½ çš„é¡¹ç›®ç›´æ¥å¯¹æ ‡ä»–ä»¬çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½
- å±•ç¤ºä½ ä¸åªæ˜¯"è°ƒç”¨ gRPC API"ï¼Œè€Œæ˜¯ç†è§£ RPC åº•å±‚æ¯ä¸€å±‚åœ¨åšä»€ä¹ˆ
- æ¯ä¸ªæ¨¡å—éƒ½å¯¹åº”ä¸€ä¸ªé¢è¯•é«˜é¢‘é—®é¢˜åŸŸ

### 1.3 æ ¸å¿ƒèƒ½åŠ›æ˜ å°„

```
æ¨¡å—              é¢è¯•è€ƒç‚¹                    å¯¹æ ‡å·¥ä¸šæ¡†æ¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åè®®è®¾è®¡          TCP ç²˜åŒ…/æ‹†åŒ…               gRPC (HTTP/2 framing)
åºåˆ—åŒ–            Protobuf vs JSON tradeoff   Kitex (Thrift)
è¿æ¥æ± +å¤šè·¯å¤ç”¨   é«˜å¹¶å‘ç½‘ç»œç¼–ç¨‹               Dubbo è¿æ¥ç®¡ç†
æœåŠ¡å‘ç°          etcd/ZooKeeper åŸç†          Kitex + etcd
è´Ÿè½½å‡è¡¡          ä¸€è‡´æ€§å“ˆå¸Œ/åŠ æƒè½®è¯¢          tRPC è´Ÿè½½å‡è¡¡
ä¸­é—´ä»¶é“¾          æ´‹è‘±æ¨¡å‹/AOP æ€æƒ³            Gin middleware
```

---

## 2. æ•´ä½“æ¶æ„è®¾è®¡

### 2.1 æ¶æ„å¤§å›¾

```
                          Mini-RPC Architecture
                          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Client Side                                      Server Side
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user code: result := client.Add(1,2) â”‚  â”‚ user code: func Add(a, b int) int    â”‚
â”‚                  â”‚                   â”‚  â”‚                  â–²                   â”‚
â”‚                  â–¼                   â”‚  â”‚                  â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Client Stub  â”‚ reflect/interface  â”‚  â”‚  â”‚ Server Stub  â”‚ reflect/register   â”‚
â”‚  â”‚   (Proxy)    â”‚                    â”‚  â”‚  â”‚(Dispatcher)  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                            â”‚  â”‚         â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Middleware   â”‚ timeout/limit/traceâ”‚  â”‚  â”‚ Middleware   â”‚                    â”‚
â”‚  â”‚   Chain      â”‚                    â”‚  â”‚  â”‚   Chain      â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                            â”‚  â”‚         â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Codec        â”‚ bytes ---------->  â”‚  â”‚  â”‚ Codec        â”‚ <---------- bytes  â”‚
â”‚  â”‚ (JSON/Bin)   â”‚                    â”‚  â”‚  â”‚ (JSON/Bin)   â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                            â”‚  â”‚         â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Protocol     â”‚ frame ---------->  â”‚  â”‚  â”‚ Protocol     â”‚ <---------- frame  â”‚
â”‚  â”‚ (Frame)      â”‚                    â”‚  â”‚  â”‚ (Frame)      â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                            â”‚  â”‚         â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Transport    â”‚ pool + multiplex   â”‚  â”‚  â”‚ Transport    â”‚ accept + dispatch  â”‚
â”‚  â”‚ (ConnPool)   â”‚                    â”‚  â”‚  â”‚ (Listener)   â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                            â”‚  â”‚         â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚         â”‚                            â”‚
â”‚  â”‚ Registry+LB  â”‚ discover + route   â”‚  â”‚         â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚         â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                                â”‚
                   â””â”€â”€â”€â”€â”€â”€ TCP Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸€æ¬¡å®Œæ•´è°ƒç”¨çš„æ•°æ®æµ

```
1. Client è°ƒç”¨ client.Call("UserService.GetUser", req, &resp)
2. Client Stub æ„å»º RPC è¯·æ±‚ç»“æ„ä½“: {ServiceMethod, Seq, Args}
3. Middleware Chain ä¾æ¬¡æ‰§è¡Œ: è¶…æ—¶æ§åˆ¶ â†’ é™æµæ£€æŸ¥ â†’ é“¾è·¯è¿½è¸ªæ³¨å…¥
4. Codec å°†è¯·æ±‚åºåˆ—åŒ–ä¸ºå­—èŠ‚æµ (JSON æˆ–äºŒè¿›åˆ¶)
5. Protocol åœ¨å­—èŠ‚æµå‰é¢åŠ ä¸Šå¸§å¤´ (MagicNumber + Length + å…ƒä¿¡æ¯)
6. Transport ä»è¿æ¥æ± å–ä¸€æ¡ TCP è¿æ¥ï¼Œå‘é€å¸§æ•°æ®
7. ---- ç½‘ç»œä¼ è¾“ ----
8. Server Transport çš„ Accept å¾ªç¯æ”¶åˆ°è¿æ¥ï¼Œå¯åŠ¨ goroutine å¤„ç†
9. Server Protocol ä» TCP æµä¸­æŒ‰å¸§å¤´åˆ‡å‡ºå®Œæ•´æ¶ˆæ¯
10. Server Codec ååºåˆ—åŒ–ï¼Œå¾—åˆ° {ServiceMethod, Seq, Args}
11. Server Middleware Chain æ‰§è¡Œ
12. Server Stub (Dispatcher) æ ¹æ® ServiceMethod æ‰¾åˆ°å¯¹åº”å‡½æ•°ï¼Œé€šè¿‡åå°„è°ƒç”¨
13. å°†è¿”å›å€¼æ²¿åŸè·¯è¿”å›: Codec â†’ Protocol â†’ Transport â†’ Client
14. Client Transport æ ¹æ® Seq (è¯·æ±‚ID) åŒ¹é…åˆ°å¯¹åº”çš„ç­‰å¾… channel
15. Client è§£åŒ…å“åº”ï¼Œè¿”å›ç»™ç”¨æˆ·ä»£ç 
```

---

## 3. æ¨¡å—ä¸€ï¼šåè®®è®¾è®¡ï¼ˆProtocolï¼‰

### 3.1 è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

TCP æ˜¯å­—èŠ‚æµåè®®ï¼Œä¸ä¿ç•™æ¶ˆæ¯è¾¹ç•Œã€‚è¿ç»­å‘é€ "Hello" å’Œ "World"ï¼Œæ¥æ”¶æ–¹å¯èƒ½æ”¶åˆ°ï¼š

- "HelloWorld"ï¼ˆç²˜åŒ…ï¼‰
- "Hel" + "loWorld"ï¼ˆæ‹†åŒ…ï¼‰
- "HelloWor" + "ld"ï¼ˆä¸¤è€…çš†æœ‰ï¼‰

æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹å¼ï¼Œè®©æ¥æ”¶æ–¹èƒ½ä»è¿ç»­å­—èŠ‚æµä¸­å‡†ç¡®åˆ‡å‡ºæ¯ä¸€æ¡å®Œæ•´çš„ RPC æ¶ˆæ¯ã€‚

### 3.2 è§£å†³æ–¹æ¡ˆï¼šå®šé•¿å¸§å¤´ + å˜é•¿æ¶ˆæ¯ä½“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header (fixed 14 bytes)                                      â”‚  â”‚ Body       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”¤  â”‚ (variable) â”‚
â”‚ Magic(3) â”‚ Ver(1)  â”‚ Codec(1) â”‚ Type(1) â”‚ Seq(4) â”‚ Len(4)    â”‚  â”‚ ...bytes   â”‚
â”‚ "mrp"    â”‚ 0x01    â”‚ 0=JSON   â”‚ 0=Req   â”‚ uint32 â”‚ uint32    â”‚  â”‚            â”‚
â”‚          â”‚         â”‚ 1=Binary â”‚ 1=Resp  â”‚        â”‚           â”‚  â”‚            â”‚
â”‚          â”‚         â”‚          â”‚ 2=HB    â”‚        â”‚           â”‚  â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»å¸§ = 14 å­—èŠ‚å¸§å¤´ + BodyLen å­—èŠ‚æ¶ˆæ¯ä½“
```

### 3.3 å„å­—æ®µè¯¦è§£

| å­—æ®µ         | å¤§å°    | è¯´æ˜                               | è®¾è®¡ç†ç”±                                                 |
| ------------ | ------- | ---------------------------------- | -------------------------------------------------------- |
| Magic Number | 3 bytes | å›ºå®šå€¼ `0x6d7270` ("mrp")        | å¿«é€Ÿè¯†åˆ«åè®®ï¼Œé˜²æ­¢éæ³•è¿æ¥ï¼ˆæ¯”å¦‚æœ‰äººæ‹¿æµè§ˆå™¨è¿ä½ çš„ç«¯å£ï¼‰ |
| Version      | 1 byte  | åè®®ç‰ˆæœ¬å·ï¼Œå½“å‰ä¸º 1               | æœªæ¥å‡çº§åè®®æ—¶å¯ä»¥å‘åå…¼å®¹                               |
| Codec Type   | 1 byte  | 0=JSON, 1=Binary                   | å…è®¸åŒä¸€æ¡†æ¶æ”¯æŒå¤šç§åºåˆ—åŒ–                               |
| Message Type | 1 byte  | 0=Request, 1=Response, 2=Heartbeat | åŒºåˆ†è¯·æ±‚å’Œå“åº”ï¼Œå¿ƒè·³åŒ…ä¸æºå¸¦ä¸šåŠ¡æ•°æ®                     |
| Sequence ID  | 4 bytes | è¯·æ±‚åºåˆ—å· (uint32, å¤§ç«¯åº)        | å¤šè·¯å¤ç”¨çš„å…³é”®ï¼šåŒ¹é…è¯·æ±‚å’Œå“åº”                           |
| Body Length  | 4 bytes | æ¶ˆæ¯ä½“é•¿åº¦ (uint32, å¤§ç«¯åº)        | è§£å†³ TCP ç²˜åŒ…ï¼šå…ˆè¯»å¸§å¤´æ‹¿åˆ°é•¿åº¦ï¼Œå†è¯»å¯¹åº”å­—èŠ‚æ•°          |

### 3.4 ç¼–è§£ç æµç¨‹

**ç¼–ç ï¼ˆå‘é€æ–¹ï¼‰:**

```
1. å†™å…¥ 3 å­—èŠ‚ Magic Number
2. å†™å…¥ 1 å­—èŠ‚ Version
3. å†™å…¥ 1 å­—èŠ‚ Codec Type
4. å†™å…¥ 1 å­—èŠ‚ Message Type
5. å†™å…¥ 4 å­—èŠ‚ Sequence ID (big-endian)
6. å°†æ¶ˆæ¯ä½“åºåˆ—åŒ–ä¸ºå­—èŠ‚
7. å†™å…¥ 4 å­—èŠ‚ Body Length (big-endian)
8. å†™å…¥æ¶ˆæ¯ä½“å­—èŠ‚
```

**è§£ç ï¼ˆæ¥æ”¶æ–¹ï¼‰:**

```
1. è¯»å– 14 å­—èŠ‚å¸§å¤´
2. æ ¡éªŒ Magic Numberï¼Œä¸åŒ¹é…åˆ™æ–­å¼€è¿æ¥
3. è§£æ Versionã€Codec Typeã€Message Typeã€Seq
4. è¯»å– Body Length
5. ç²¾ç¡®è¯»å– BodyLength å­—èŠ‚ä½œä¸ºæ¶ˆæ¯ä½“
6. ç”¨å¯¹åº” Codec ååºåˆ—åŒ–æ¶ˆæ¯ä½“
```

### 3.5 æ ¸å¿ƒä»£ç ç»“æ„

```go
// protocol/protocol.go

const (
    MagicNumber byte = 0x6d // 'm'
    MagicByte2  byte = 0x72 // 'r'
    MagicByte3  byte = 0x70 // 'p'
    Version     byte = 0x01
    HeaderSize       = 14 // 3+1+1+1+4+4 = 14 bytes
)

type MsgType byte

const (
    MsgTypeRequest  MsgType = 0
    MsgTypeResponse MsgType = 1
    MsgTypeHeartbeat MsgType = 2
)

type Header struct {
    CodecType  byte    // 0=JSON, 1=Binary
    MsgType    MsgType
    Seq        uint32
    BodyLen    uint32
}

// Encode å°†å¸§å¤´å†™å…¥ writer
func Encode(w io.Writer, h *Header, body []byte) error {
    // å†™ magic + version
    // å†™ codecType, msgType
    // å†™ seq (big-endian)
    // å†™ bodyLen (big-endian)
    // å†™ body
}

// Decode ä» reader è¯»å–å¸§å¤´å’Œæ¶ˆæ¯ä½“
func Decode(r io.Reader) (*Header, []byte, error) {
    // è¯» 14 å­—èŠ‚å¸§å¤´
    // æ ¡éªŒ magic
    // è§£æå„å­—æ®µ
    // æŒ‰ bodyLen è¯»å–æ¶ˆæ¯ä½“
}
```

### 3.6 è®¾è®¡å†³ç­–ä¸ Tradeoff

**Q: ä¸ºä»€ä¹ˆä¸ç”¨ "æ¢è¡Œç¬¦ \n" ä½œä¸ºæ¶ˆæ¯åˆ†éš”ï¼Ÿ**
A: RPC æ¶ˆæ¯ä½“æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œå¯èƒ½åŒ…å« `\n`ï¼Œå¯¼è‡´è¯¯åˆ‡å‰²ã€‚å®šé•¿å¸§å¤´ + é•¿åº¦å‰ç¼€æ˜¯å”¯ä¸€å¯é æ–¹æ¡ˆã€‚

**Q: ä¸ºä»€ä¹ˆç”¨ Big-Endianï¼Ÿ**
A: ç½‘ç»œå­—èŠ‚åºçº¦å®šï¼ˆNetwork Byte Orderï¼‰ï¼Œæ‰€æœ‰ä¸»æµç½‘ç»œåè®®éƒ½ç”¨å¤§ç«¯åºï¼Œè·¨å¹³å°å…¼å®¹ã€‚

**Q: å¸§å¤´ä¸ºä»€ä¹ˆä¸ç”¨å˜é•¿ç¼–ç ï¼ˆå¦‚ Protobuf çš„ Varintï¼‰ï¼Ÿ**
A: å®šé•¿å¸§å¤´è§£ææ›´å¿«ï¼ˆç›´æ¥æŒ‰åç§»è¯»ï¼‰ï¼Œä¸éœ€è¦å¾ªç¯åˆ¤æ–­ã€‚å¸§å¤´åªæœ‰ 14 å­—èŠ‚ï¼Œçœä¸äº†å¤šå°‘ç©ºé—´ï¼Œä½†ä¼šå¢åŠ å¤æ‚åº¦ã€‚

**Q: ä¸ºä»€ä¹ˆéœ€è¦ Magic Numberï¼Ÿ**
A: é˜²å¾¡æ€§ç¼–ç¨‹ã€‚å¦‚æœæœ‰äººè¯¯è¿äº†ä½ çš„ç«¯å£ï¼ˆæ¯”å¦‚ç”¨ HTTP å®¢æˆ·ç«¯è¿ï¼‰ï¼Œç¬¬ä¸€æ¬¡è¯»å–å°±èƒ½è¯†åˆ«å¹¶æ‹’ç»ã€‚gRPC ç”¨ "PRI * HTTP/2.0" ä½œä¸ºç±»ä¼¼æœºåˆ¶ã€‚

---

## 4. æ¨¡å—äºŒï¼šåºåˆ—åŒ–ï¼ˆCodecï¼‰

### 4.1 è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

Go çš„ struct åœ¨å†…å­˜é‡Œæ˜¯ä¸€å †åˆ†æ•£çš„å­—æ®µï¼ŒåŒ…å«æŒ‡é’ˆã€åˆ‡ç‰‡å¤´ç­‰è¿è¡Œæ—¶ç»“æ„ã€‚è¿™äº›ä¸œè¥¿ä¸èƒ½ç›´æ¥é€šè¿‡ç½‘ç»œå‘é€ã€‚
æˆ‘ä»¬éœ€è¦æŠŠ struct å˜æˆ"æ‰å¹³çš„å­—èŠ‚æµ"ï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œå¯¹æ–¹æ”¶åˆ°åå†è¿˜åŸå› structï¼ˆååºåˆ—åŒ–ï¼‰ã€‚

### 4.2 Codec æ¥å£è®¾è®¡

```go
// codec/codec.go

type Codec interface {
    Encode(v interface{}) ([]byte, error)
    Decode(data []byte, v interface{}) error
    Type() byte  // 0=JSON, 1=Binary
}
```

### 4.3 å®ç°ä¸€ï¼šJSON Codec

```go
// codec/json_codec.go

type JSONCodec struct{}

func (c *JSONCodec) Encode(v interface{}) ([]byte, error) {
    return json.Marshal(v)
}

func (c *JSONCodec) Decode(data []byte, v interface{}) error {
    return json.Unmarshal(data, v)
}

func (c *JSONCodec) Type() byte { return 0 }
```

**ä¼˜ç‚¹**: äººç±»å¯è¯»ã€è°ƒè¯•æ–¹ä¾¿ã€è·¨è¯­è¨€
**ç¼ºç‚¹**: æ€§èƒ½å·®ï¼ˆåå°„ + å­—ç¬¦ä¸²è§£æï¼‰ã€ä½“ç§¯å¤§ï¼ˆå­—æ®µåé‡å¤ä¼ è¾“ï¼‰

### 4.4 å®ç°äºŒï¼šè‡ªå®šä¹‰äºŒè¿›åˆ¶ Codec

è®¾è®¡ä¸€ç§ç®€å•çš„äºŒè¿›åˆ¶ç¼–ç ï¼š

```
RPC æ¶ˆæ¯ä½“æ ¼å¼:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ServiceMethod                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ StrLen (2B) â”‚ String bytes                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ Args/Reply (payload, JSON bytes)                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ DataLen(4B) â”‚ JSON bytes                                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ Error (empty string means no error)                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ StrLen (2B) â”‚ String bytes                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ³¨æ„: Args/Reply å†…éƒ¨ä»ç”¨ JSON åºåˆ—åŒ–ï¼ˆç®€åŒ–å®ç°ï¼‰ã€‚æ€§èƒ½æå‡æ¥è‡ªå¸§å¤´å’Œå…ƒä¿¡æ¯çš„äºŒè¿›åˆ¶ç¼–ç ï¼Œé¿å…äº† JSON å¤–å±‚çš„å¼€é”€ã€‚å®Œæ•´äºŒè¿›åˆ¶åºåˆ—åŒ–ï¼ˆç±»ä¼¼ Protobufï¼‰å¤æ‚åº¦å¤ªé«˜ï¼Œ25 å¤©å†…ä¸å€¼å¾—åšã€‚

### 4.5 RPC æ¶ˆæ¯ç»“æ„ä½“å®šä¹‰

```go
// message/message.go

// Request è¡¨ç¤ºä¸€æ¬¡ RPC è¯·æ±‚
type Request struct {
    ServiceMethod string // æ ¼å¼: "Service.Method"
    Seq           uint32 // è¯·æ±‚åºåˆ—å·
    Args          interface{}
}

// Response è¡¨ç¤ºä¸€æ¬¡ RPC å“åº”
type Response struct {
    ServiceMethod string
    Seq           uint32
    Reply         interface{}
    Error         string // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ— é”™è¯¯
}
```

### 4.6 è®¾è®¡å†³ç­–ä¸ Tradeoff

**Q: ä¸ºä»€ä¹ˆä¸å®Œæ•´å®ç° Protobufï¼Ÿ**
A: Protobuf éœ€è¦ IDLï¼ˆ.proto æ–‡ä»¶ï¼‰ã€ä»£ç ç”Ÿæˆå™¨ã€Varint ç¼–ç ã€Wire Type ç­‰ï¼Œå·¥ä½œé‡å·¨å¤§ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å±•ç¤º"ç†è§£åºåˆ—åŒ–åŸç†"ï¼Œä¸æ˜¯é‡é€  Protobufã€‚é¢è¯•æ—¶å¯ä»¥è¯´"å¦‚æœè¦åšç”Ÿäº§çº§ï¼Œä¼šç”¨ Protobuf æˆ– Flatbuffers"ã€‚

**Q: ä¸ºä»€ä¹ˆåŒæ—¶æ”¯æŒ JSON å’Œ Binaryï¼Ÿ**
A: å±•ç¤º Codec æ¥å£çš„å¯æ‰©å±•æ€§ã€‚é¢è¯•å®˜çœ‹åˆ° `Codec interface` + ä¸¤ä¸ªå®ç°ï¼Œç«‹åˆ»çŸ¥é“ä½ ç†è§£"é¢å‘æ¥å£ç¼–ç¨‹"å’Œ"ç­–ç•¥æ¨¡å¼"ã€‚

---

## 5. æ¨¡å—ä¸‰ï¼šä¼ è¾“å±‚ï¼ˆTransportï¼‰

### 5.1 è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

æ¯æ¬¡ RPC è°ƒç”¨éƒ½å»ºä¸€æ¡ TCP è¿æ¥ï¼Œæˆæœ¬æé«˜ï¼ˆä¸‰æ¬¡æ¡æ‰‹ + å†…æ ¸ç¼“å†²åŒºåˆ†é…ï¼‰ã€‚
åŒæ—¶ï¼Œä¸€æ¡ TCP è¿æ¥ä¸Šå¦‚æœåªèƒ½ä¸²è¡Œå‘è¯·æ±‚ï¼ˆå‘ä¸€ä¸ªç­‰ä¸€ä¸ªï¼‰ï¼Œååé‡æä½ã€‚

### 5.2 è§£å†³æ–¹æ¡ˆä¸€ï¼šè¿æ¥æ± 

```
æ²¡æœ‰è¿æ¥æ± :
  è¯·æ±‚1 â†’ å»ºè¿ â†’ å‘é€ â†’ æ¥æ”¶ â†’ æ–­è¿
  è¯·æ±‚2 â†’ å»ºè¿ â†’ å‘é€ â†’ æ¥æ”¶ â†’ æ–­è¿   (æ¯æ¬¡éƒ½ä¸‰æ¬¡æ¡æ‰‹)

æœ‰è¿æ¥æ± :
  åˆå§‹åŒ–: é¢„å…ˆå»ºå¥½ N æ¡è¿æ¥æ”¾å…¥æ± ä¸­

  è¯·æ±‚1 â†’ ä»æ± ä¸­å–è¿æ¥ â†’ å‘é€ â†’ æ¥æ”¶ â†’ å½’è¿˜åˆ°æ± ä¸­
  è¯·æ±‚2 â†’ ä»æ± ä¸­å–è¿æ¥ â†’ å‘é€ â†’ æ¥æ”¶ â†’ å½’è¿˜åˆ°æ± ä¸­  (å¤ç”¨è¿æ¥)
```

#### è¿æ¥æ± æ ¸å¿ƒè®¾è®¡

```go
// transport/pool.go

type ConnPool struct {
    mu       sync.Mutex
    conns    chan *PoolConn // ç¼“å†² channel ä½œä¸ºæ± 
    addr     string
    maxConns int
    curConns int           // å½“å‰å·²åˆ›å»ºçš„è¿æ¥æ•°
    factory  func() (net.Conn, error)
}

type PoolConn struct {
    net.Conn
    pool     *ConnPool
    unusable bool  // æ ‡è®°è¿æ¥æ˜¯å¦å·²æŸå
}

// Get ä»æ± ä¸­è·å–è¿æ¥
func (p *ConnPool) Get() (*PoolConn, error) {
    select {
    case conn := <-p.conns:
        if conn.unusable {
            return p.createNew()
        }
        return conn, nil
    default:
        // æ± ç©ºäº†
        if p.curConns < p.maxConns {
            return p.createNew()
        }
        // å·²è¾¾ä¸Šé™ï¼Œé˜»å¡ç­‰å¾…
        conn := <-p.conns
        return conn, nil
    }
}

// Put å½’è¿˜è¿æ¥åˆ°æ± ä¸­
func (p *ConnPool) Put(conn *PoolConn) {
    if conn.unusable {
        conn.Close()
        p.mu.Lock()
        p.curConns--
        p.mu.Unlock()
        return
    }
    p.conns <- conn
}
```

#### è¿æ¥å¥åº·æ£€æŸ¥

```
ç­–ç•¥: ä½¿ç”¨å‰æ£€æŸ¥ + å¿ƒè·³ä¿æ´»

1. å–å‡ºè¿æ¥æ—¶: æ£€æŸ¥è¿æ¥æ˜¯å¦è¿˜å­˜æ´»ï¼ˆå°è¯• SetReadDeadline + Read 1 å­—èŠ‚ï¼‰
2. å½’è¿˜è¿æ¥æ—¶: å¦‚æœä¸Šæ¬¡è¯·æ±‚å‡ºé”™ï¼Œæ ‡è®°ä¸º unusableï¼Œä¸æ”¾å›æ± ä¸­
3. åå° goroutine: æ¯ 30 ç§’å¯¹æ± ä¸­ç©ºé—²è¿æ¥å‘å¿ƒè·³åŒ…ï¼ˆMsgType=Heartbeatï¼‰
```

### 5.3 è§£å†³æ–¹æ¡ˆäºŒï¼šå¤šè·¯å¤ç”¨

```
æ²¡æœ‰å¤šè·¯å¤ç”¨ï¼ˆä¸²è¡Œï¼‰:
  è¿æ¥1: [è¯·æ±‚1 å‘é€] â†’ [ç­‰è¯·æ±‚1å“åº”] â†’ [è¯·æ±‚2 å‘é€] â†’ [ç­‰è¯·æ±‚2å“åº”]
  ååé‡: å—é™äº RTT

æœ‰å¤šè·¯å¤ç”¨:
  è¿æ¥1: [è¯·æ±‚1å‘é€][è¯·æ±‚2å‘é€][è¯·æ±‚3å‘é€] â†’ [å“åº”2åˆ°è¾¾][å“åº”1åˆ°è¾¾][å“åº”3åˆ°è¾¾]
  å…³é”®: ç”¨ Sequence ID åŒ¹é…è¯·æ±‚å’Œå“åº”ï¼Œå“åº”å¯ä»¥ä¹±åºåˆ°è¾¾
```

#### å¤šè·¯å¤ç”¨æ ¸å¿ƒè®¾è®¡

```go
// transport/client_transport.go

type ClientTransport struct {
    conn     net.Conn
    codec    codec.Codec
    seq      uint32          // åŸå­é€’å¢çš„è¯·æ±‚åºåˆ—å·
    pending  sync.Map        // map[uint32]chan *Response  ç­‰å¾…å“åº”çš„è¯·æ±‚
    sending  sync.Mutex      // å‘é€é”ï¼ˆåŒä¸€è¿æ¥ä¸Šçš„å†™å¿…é¡»ä¸²è¡Œï¼Œå¦åˆ™å¸§ä¼šäº¤é”™ï¼‰
}

// Send å‘é€è¯·æ±‚ï¼Œè¿”å›ä¸€ä¸ª channel ç­‰å¾…å“åº”
func (t *ClientTransport) Send(req *Request) (<-chan *Response, error) {
    seq := atomic.AddUint32(&t.seq, 1)
    req.Seq = seq

    ch := make(chan *Response, 1)
    t.pending.Store(seq, ch)

    // è·å–å‘é€é”ï¼Œåºåˆ—åŒ–å¹¶å†™å…¥è¿æ¥
    t.sending.Lock()
    err := t.writeFrame(req)
    t.sending.Unlock()

    if err != nil {
        t.pending.Delete(seq)
        return nil, err
    }
    return ch, nil
}

// recvLoop åå° goroutineï¼ŒæŒç»­è¯»å–å“åº”å¹¶åˆ†å‘
func (t *ClientTransport) recvLoop() {
    for {
        resp, err := t.readFrame()
        if err != nil {
            t.closeAllPending(err)
            return
        }
        if ch, ok := t.pending.LoadAndDelete(resp.Seq); ok {
            ch.(chan *Response) <- resp
        }
    }
}
```

### 5.4 Server ç«¯ä¼ è¾“å±‚

```go
// transport/server_transport.go

type ServerTransport struct {
    listener net.Listener
    handler  func(req *Request) *Response
}

func (t *ServerTransport) Serve() error {
    for {
        conn, err := t.listener.Accept()
        if err != nil {
            return err
        }
        go t.handleConn(conn) // æ¯ä¸ªè¿æ¥ä¸€ä¸ª goroutine
    }
}

func (t *ServerTransport) handleConn(conn net.Conn) {
    defer conn.Close()
    for {
        // 1. ä»è¿æ¥è¯»å–ä¸€ä¸ªå®Œæ•´å¸§
        req, err := readFrame(conn)
        if err != nil {
            return
        }
        // 2. æ¯ä¸ªè¯·æ±‚ä¸€ä¸ª goroutine å¤„ç†ï¼ˆè¿æ¥ä¸Šçš„å¹¶å‘è¯·æ±‚ï¼‰
        go func(req *Request) {
            resp := t.handler(req)
            // å†™å“åº”éœ€è¦åŠ é”ï¼ˆåŒä¸€è¿æ¥ä¸Šçš„å†™å¿…é¡»ä¸²è¡Œï¼‰
            writeFrame(conn, resp)
        }(req)
    }
}
```

### 5.5 è®¾è®¡å†³ç­–ä¸ Tradeoff

**Q: ä¸ºä»€ä¹ˆå†™å¿…é¡»åŠ é”ä½†è¯»ä¸ç”¨ï¼Ÿ**
A: TCP æ˜¯åŒå‘çš„ã€‚è¯»å’Œå†™æ“ä½œåœ¨ä¸åŒçš„ç¼“å†²åŒºä¸Šï¼Œäº’ä¸å½±å“ã€‚ä½†å¦‚æœä¸¤ä¸ª goroutine åŒæ—¶å†™ï¼Œå¸§æ•°æ®ä¼šäº¤é”™ï¼ˆè¯·æ±‚ A çš„å¸§å¤´ + è¯·æ±‚ B çš„æ¶ˆæ¯ä½“ï¼‰ï¼Œæ¥æ”¶æ–¹æ— æ³•è§£æã€‚

**Q: è¿æ¥æ± æ»¡äº†æ€ä¹ˆåŠï¼Ÿ**
A: ä¸¤ç§ç­–ç•¥â€”â€”é˜»å¡ç­‰å¾…ï¼ˆå½“å‰è®¾è®¡ï¼‰æˆ–å¿«é€Ÿå¤±è´¥è¿”å›é”™è¯¯ã€‚ç”Ÿäº§ä¸­é€šå¸¸è®¾è¶…æ—¶ï¼šç­‰å¾… X æ¯«ç§’ï¼Œè¶…æ—¶åˆ™æŠ¥é”™ã€‚é¢è¯•æ—¶è¯´æ¸…æ¥šè¿™ä¸ª tradeoffã€‚

**Q: å¤šè·¯å¤ç”¨ vs è¿æ¥æ± ï¼Œä¸ºä»€ä¹ˆä¸¤ä¸ªéƒ½è¦ï¼Ÿ**
A: å¤šè·¯å¤ç”¨æé«˜å•è¿æ¥åˆ©ç”¨ç‡ï¼Œè¿æ¥æ± å¢åŠ æ€»å¹¶å‘èƒ½åŠ›ã€‚çœŸå®åœºæ™¯ä¸­ä¸¤è€…é…åˆä½¿ç”¨ï¼šæ± ä¸­æœ‰ N æ¡è¿æ¥ï¼Œæ¯æ¡æ”¯æŒå¤šè·¯å¤ç”¨ã€‚ç±»ä¼¼é«˜é€Ÿå…¬è·¯æœ‰ N æ¡è½¦é“ï¼ˆè¿æ¥æ± ï¼‰ï¼Œæ¯æ¡è½¦é“ä¸Šå¯ä»¥è·‘å¤šè¾†è½¦ï¼ˆå¤šè·¯å¤ç”¨ï¼‰ã€‚

---

## 6. æ¨¡å—å››ï¼šæœåŠ¡æ³¨å†Œä¸å‘ç°ï¼ˆRegistryï¼‰

### 6.1 è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

å®¢æˆ·ç«¯æ€ä¹ˆçŸ¥é“æœåŠ¡ç«¯çš„ IP å’Œç«¯å£ï¼Ÿç¡¬ç¼–ç æ˜¾ç„¶ä¸è¡Œâ€”â€”æœåŠ¡å¯èƒ½é‡å¯æ¢ IPã€å¯èƒ½æœ‰å¤šä¸ªå®ä¾‹ã€å¯èƒ½åŠ¨æ€æ‰©ç¼©å®¹ã€‚

### 6.2 è§£å†³æ–¹æ¡ˆï¼šåŸºäº etcd çš„æ³¨å†Œä¸å‘ç°

```
æœåŠ¡å¯åŠ¨æµç¨‹:
  Server å¯åŠ¨ â†’ å‘ etcd æ³¨å†Œ (key="/mini-rpc/UserService/192.168.1.1:8080", value=å…ƒä¿¡æ¯)
              â†’ è®¾ç½® TTL ç§Ÿçº¦ (æ¯”å¦‚ 10 ç§’)
              â†’ åå° goroutine æ¯ 3 ç§’ç»­çº¦

å®¢æˆ·ç«¯å‘ç°æµç¨‹:
  Client å¯åŠ¨ â†’ ä» etcd æŸ¥è¯¢ prefix="/mini-rpc/UserService/" è·å–æ‰€æœ‰å®ä¾‹
              â†’ Watch è¿™ä¸ª prefixï¼Œå®æ—¶æ„ŸçŸ¥å®ä¾‹ä¸Šä¸‹çº¿
              â†’ ç»´æŠ¤ä¸€ä¸ªæœ¬åœ°çš„æœåŠ¡å®ä¾‹åˆ—è¡¨
```

#### etcd ä¸­çš„æ•°æ®ç»“æ„

```
/mini-rpc/
â”œâ”€â”€ UserService/
â”‚   â”œâ”€â”€ 192.168.1.1:8080  â†’ {"weight": 10, "version": "1.0"}
â”‚   â”œâ”€â”€ 192.168.1.2:8080  â†’ {"weight": 5, "version": "1.0"}
â”‚   â””â”€â”€ 192.168.1.3:8080  â†’ {"weight": 10, "version": "1.1"}
â””â”€â”€ OrderService/
    â””â”€â”€ 10.0.0.1:9090     â†’ {"weight": 10, "version": "2.0"}
```

### 6.3 æ ¸å¿ƒä»£ç ç»“æ„

```go
// registry/registry.go

type ServiceInstance struct {
    Addr    string
    Weight  int
    Version string
}

// Registry æ¥å£ï¼Œå¯ä»¥æœ‰ etcd å®ç°å’Œæœ¬åœ°å®ç°
type Registry interface {
    Register(serviceName string, instance ServiceInstance, ttl int64) error
    Deregister(serviceName string, addr string) error
    Discover(serviceName string) ([]ServiceInstance, error)
    Watch(serviceName string) <-chan []ServiceInstance
}
```

```go
// registry/etcd_registry.go

type EtcdRegistry struct {
    client  *clientv3.Client
    leaseID clientv3.LeaseID
}

func (r *EtcdRegistry) Register(serviceName string, inst ServiceInstance, ttl int64) error {
    // 1. åˆ›å»ºç§Ÿçº¦
    lease, _ := r.client.Grant(context.TODO(), ttl)
    r.leaseID = lease.ID

    // 2. æ³¨å†Œ KVï¼ˆå¸¦ç§Ÿçº¦ï¼‰
    key := fmt.Sprintf("/mini-rpc/%s/%s", serviceName, inst.Addr)
    val, _ := json.Marshal(inst)
    r.client.Put(context.TODO(), key, string(val), clientv3.WithLease(lease.ID))

    // 3. åå°ç»­çº¦
    ch, _ := r.client.KeepAlive(context.TODO(), lease.ID)
    go func() {
        for range ch {} // æ¶ˆè´¹ç»­çº¦å“åº”
    }()
    return nil
}

func (r *EtcdRegistry) Watch(serviceName string) <-chan []ServiceInstance {
    ch := make(chan []ServiceInstance, 1)
    prefix := fmt.Sprintf("/mini-rpc/%s/", serviceName)

    go func() {
        wch := r.client.Watch(context.TODO(), prefix, clientv3.WithPrefix())
        for range wch {
            // æ”¶åˆ°å˜æ›´äº‹ä»¶ï¼Œé‡æ–°æ‹‰å–å…¨é‡åˆ—è¡¨
            instances, _ := r.Discover(serviceName)
            ch <- instances
        }
    }()
    return ch
}
```

### 6.4 ä¼˜é›…å…³é—­

```
Server å…³é—­æµç¨‹:
  1. æ”¶åˆ° SIGTERM/SIGINT ä¿¡å·
  2. å…ˆä» etcd ä¸»åŠ¨æ³¨é”€ï¼ˆDeregisterï¼‰
  3. ç­‰å¾…å·²æœ‰è¯·æ±‚å¤„ç†å®Œï¼ˆè®¾è¶…æ—¶ï¼Œæ¯”å¦‚ 5 ç§’ï¼‰
  4. å…³é—­ listenerï¼Œä¸å†æ¥å—æ–°è¿æ¥
  5. å…³é—­å·²æœ‰è¿æ¥ï¼Œé€€å‡º

ä¸ºä»€ä¹ˆè¦å…ˆæ³¨é”€å†å…³é—­ï¼Ÿ
  å¦‚æœç›´æ¥å…³é—­ï¼Œå®¢æˆ·ç«¯è¿˜ä¼šå¾€è¿™ä¸ªåœ°å€å‘è¯·æ±‚ï¼Œå¯¼è‡´è¿æ¥å¤±è´¥ã€‚
  å…ˆæ³¨é”€å¯ä»¥è®©å®¢æˆ·ç«¯é€šè¿‡ Watch æ„ŸçŸ¥åˆ°ä¸‹çº¿ï¼Œä¸å†è·¯ç”±è¿‡æ¥ã€‚
```

### 6.5 è®¾è®¡å†³ç­–ä¸ Tradeoff

**Q: etcd æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ**
A: å®¢æˆ·ç«¯æœ¬åœ°ç¼“å­˜æœ€åä¸€æ¬¡æ‹‰å–çš„å®ä¾‹åˆ—è¡¨ã€‚etcd æŒ‚æ‰åçŸ­æ—¶é—´å†…ä»å¯æ­£å¸¸å·¥ä½œï¼ˆåªæ˜¯ä¸èƒ½æ„ŸçŸ¥æ–°çš„ä¸Šä¸‹çº¿ï¼‰ã€‚è¿™å°±æ˜¯"æœ€ç»ˆä¸€è‡´æ€§"çš„è®¾è®¡ã€‚

**Q: ä¸ºä»€ä¹ˆä¸ç”¨ ZooKeeperï¼Ÿ**
A: etcd æ˜¯ Go åŸç”Ÿç”Ÿæ€ï¼ˆCoreOS å‡ºå“ï¼‰ï¼ŒAPI æ›´ç®€æ´ï¼ŒGo å®¢æˆ·ç«¯æ›´æˆç†Ÿã€‚å­—èŠ‚å’Œè…¾è®¯å¾ˆå¤šæœåŠ¡ä¹Ÿç”¨ etcdã€‚é¢è¯•æ—¶è¯´"etcd åŸºäº Raftï¼ŒZooKeeper åŸºäº ZABï¼Œä¸¤è€…éƒ½æ˜¯å¼ºä¸€è‡´çš„æ³¨å†Œä¸­å¿ƒ"å°±å¤Ÿäº†ã€‚

---

## 7. æ¨¡å—äº”ï¼šè´Ÿè½½å‡è¡¡ï¼ˆLoad Balancerï¼‰

### 7.1 æ¥å£è®¾è®¡

```go
// loadbalance/balancer.go

type Balancer interface {
    Pick(instances []ServiceInstance) (*ServiceInstance, error)
    Name() string
}
```

### 7.2 å®ç°ä¸€ï¼šè½®è¯¢ï¼ˆRound-Robinï¼‰

```go
type RoundRobinBalancer struct {
    counter uint64
}

func (b *RoundRobinBalancer) Pick(instances []ServiceInstance) (*ServiceInstance, error) {
    if len(instances) == 0 {
        return nil, ErrNoInstance
    }
    idx := atomic.AddUint64(&b.counter, 1) % uint64(len(instances))
    return &instances[idx], nil
}
```

### 7.3 å®ç°äºŒï¼šåŠ æƒéšæœºï¼ˆWeighted Randomï¼‰

```go
func (b *WeightedRandomBalancer) Pick(instances []ServiceInstance) (*ServiceInstance, error) {
    totalWeight := 0
    for _, inst := range instances {
        totalWeight += inst.Weight
    }
    r := rand.Intn(totalWeight)
    for _, inst := range instances {
        r -= inst.Weight
        if r < 0 {
            return &inst, nil
        }
    }
    return &instances[0], nil
}
```

### 7.4 å®ç°ä¸‰ï¼šä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistent Hashï¼‰

```
æ ¸å¿ƒæ€æƒ³: æŠŠæœåŠ¡å®ä¾‹å’Œè¯·æ±‚ key éƒ½æ˜ å°„åˆ°ä¸€ä¸ªç¯ä¸Š

                    0
                  â•±   â•²
                â•±       â•²
              â•±           â•²
         B â—               â— A (å®ä¾‹)
           â”‚               â”‚
           â”‚               â”‚
           â”‚   è¯·æ±‚ key    â”‚
           â”‚      â—†â”€â”€â–º     â”‚   é¡ºæ—¶é’ˆæ‰¾åˆ°æœ€è¿‘çš„å®ä¾‹ A
           â”‚               â”‚
           â”‚               â”‚
         C â—               â— A' (A çš„è™šæ‹ŸèŠ‚ç‚¹)
              â•²           â•±
                â•²       â•±
                  â•²   â•±

è™šæ‹ŸèŠ‚ç‚¹: æ¯ä¸ªçœŸå®å®ä¾‹ç”Ÿæˆ N ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå‡åŒ€åˆ†å¸ƒåœ¨ç¯ä¸Š
åŸå› : å®ä¾‹å°‘æ—¶å®¹æ˜“åˆ†å¸ƒä¸å‡ï¼Œè™šæ‹ŸèŠ‚ç‚¹è§£å†³çƒ­ç‚¹é—®é¢˜
```

```go
// loadbalance/consistent_hash.go

type ConsistentHashBalancer struct {
    replicas int           // æ¯ä¸ªå®ä¾‹çš„è™šæ‹ŸèŠ‚ç‚¹æ•°
    ring     []uint32      // æ’åºåçš„å“ˆå¸Œç¯
    nodes    map[uint32]*ServiceInstance // å“ˆå¸Œå€¼ â†’ å®ä¾‹
}

func (b *ConsistentHashBalancer) Pick(key string) (*ServiceInstance, error) {
    hash := crc32.ChecksumIEEE([]byte(key))
    // äºŒåˆ†æŸ¥æ‰¾ç¬¬ä¸€ä¸ª >= hash çš„èŠ‚ç‚¹
    idx := sort.Search(len(b.ring), func(i int) bool {
        return b.ring[i] >= hash
    })
    if idx == len(b.ring) {
        idx = 0 // ç¯å½¢ï¼Œå›åˆ°èµ·ç‚¹
    }
    return b.nodes[b.ring[idx]], nil
}
```

### 7.5 ä½•æ—¶ç”¨å“ªç§

```
Round-Robin:     æ— çŠ¶æ€æœåŠ¡ï¼Œå®ä¾‹æ€§èƒ½ç›¸è¿‘
Weighted Random: å®ä¾‹æ€§èƒ½æœ‰å·®å¼‚ï¼ˆæ–°æ—§æœºå™¨æ··éƒ¨ç½²ï¼‰
Consistent Hash: æœ‰çŠ¶æ€æˆ–éœ€è¦ç¼“å­˜äº²å’Œæ€§ï¼ˆåŒä¸€ç”¨æˆ·çš„è¯·æ±‚æ€»æ˜¯æ‰“åˆ°åŒä¸€å®ä¾‹ï¼‰
```

---

## 8. æ¨¡å—å…­ï¼šä¸­é—´ä»¶é“¾ï¼ˆMiddlewareï¼‰

### 8.1 è®¾è®¡ï¼šæ´‹è‘±æ¨¡å‹

```
è¯·æ±‚è¿›å…¥ â”€â”€â–º  [é™æµ] â”€â”€â–º [è¶…æ—¶æ§åˆ¶] â”€â”€â–º [é“¾è·¯è¿½è¸ª] â”€â”€â–º å®é™…å¤„ç†
å“åº”è¿”å› â—„â”€â”€  [é™æµ] â—„â”€â”€ [è¶…æ—¶æ§åˆ¶] â—„â”€â”€ [é“¾è·¯è¿½è¸ª] â—„â”€â”€ å®é™…å¤„ç†

æ¯ä¸€å±‚éƒ½å¯ä»¥:
  - åœ¨"è¿›å…¥"æ—¶åšå‰ç½®å¤„ç†ï¼ˆæ£€æŸ¥ã€ä¿®æ”¹è¯·æ±‚ï¼‰
  - è°ƒç”¨ä¸‹ä¸€å±‚
  - åœ¨"è¿”å›"æ—¶åšåç½®å¤„ç†ï¼ˆè®°å½•ã€ä¿®æ”¹å“åº”ï¼‰
  - æˆ–è€…ç›´æ¥ä¸­æ–­ï¼ˆæ¯”å¦‚é™æµç›´æ¥æ‹’ç»ï¼‰
```

### 8.2 æ ¸å¿ƒæ¥å£

```go
// middleware/middleware.go

// HandlerFunc æ˜¯å®é™…å¤„ç†è¯·æ±‚çš„å‡½æ•°ç±»å‹
type HandlerFunc func(ctx context.Context, req *message.Request) *message.Response

// Middleware æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ¥å—ä¸€ä¸ª Handler è¿”å›ä¸€ä¸ªæ–° Handler
type Middleware func(next HandlerFunc) HandlerFunc

// Chain æŠŠå¤šä¸ªä¸­é—´ä»¶ä¸²æˆé“¾
func Chain(middlewares ...Middleware) Middleware {
    return func(next HandlerFunc) HandlerFunc {
        for i := len(middlewares) - 1; i >= 0; i-- {
            next = middlewares[i](next)
        }
        return next
    }
}
```

### 8.3 ä¸­é—´ä»¶å®ç°ä¸€ï¼šè¶…æ—¶æ§åˆ¶

```go
func TimeoutMiddleware(timeout time.Duration) Middleware {
    return func(next HandlerFunc) HandlerFunc {
        return func(ctx context.Context, req *message.Request) *message.Response {
            ctx, cancel := context.WithTimeout(ctx, timeout)
            defer cancel()

            ch := make(chan *message.Response, 1)
            go func() {
                ch <- next(ctx, req)
            }()

            select {
            case resp := <-ch:
                return resp
            case <-ctx.Done():
                return &message.Response{Error: "request timeout"}
            }
        }
    }
}
```

### 8.4 ä¸­é—´ä»¶å®ç°äºŒï¼šä»¤ç‰Œæ¡¶é™æµ

```go
func RateLimitMiddleware(rate int, burst int) Middleware {
    limiter := rate.NewLimiter(rate.Limit(rate), burst)
    return func(next HandlerFunc) HandlerFunc {
        return func(ctx context.Context, req *message.Request) *message.Response {
            if !limiter.Allow() {
                return &message.Response{Error: "rate limited"}
            }
            return next(ctx, req)
        }
    }
}
```

### 8.5 ä¸­é—´ä»¶å®ç°ä¸‰ï¼šè¯·æ±‚æ—¥å¿—

```go
func LoggingMiddleware() Middleware {
    return func(next HandlerFunc) HandlerFunc {
        return func(ctx context.Context, req *message.Request) *message.Response {
            start := time.Now()
            resp := next(ctx, req)
            log.Printf("[RPC] %s | seq=%d | duration=%v | error=%s",
                req.ServiceMethod, req.Seq, time.Since(start), resp.Error)
            return resp
        }
    }
}
```

---

## 9. Day-by-Day æ‰§è¡Œè®¡åˆ’

### Phase 1: Mini-RPC (Day 1 ~ Day 13)

```
Day 1 (2/6):  âœ… åŸç†å­¦ä¹  â€” RPC ä¸ºä»€ä¹ˆå­˜åœ¨ï¼Œå®Œæ•´è°ƒç”¨æµç¨‹
              âœ… æ­å»ºé¡¹ç›®éª¨æ¶ (go mod init, ç›®å½•ç»“æ„, Makefile)
              âœ… å®šä¹‰æ ¸å¿ƒæ¥å£ (Codec, Registry, Balancer)
              ğŸ¯ äº§å‡º: èƒ½ç¼–è¯‘é€šè¿‡çš„ç©ºé¡¹ç›®æ¡†æ¶

Day 2 (2/7):  âœ… å®ç°åè®®å±‚ Protocol (Encode/Decode)
              âœ… å†™å•å…ƒæµ‹è¯•éªŒè¯å¸§ç¼–è§£ç æ­£ç¡®æ€§
              ğŸ¯ äº§å‡º: TestEncodeDecode é€šè¿‡

Day 3 (2/8):  âœ… å®ç° JSON Codec
              âœ… å®šä¹‰ Request/Response æ¶ˆæ¯ç»“æ„ä½“
              âœ… å®ç°ç®€æ˜“ Binary Codec
              ğŸ¯ äº§å‡º: TestJSONCodec, TestBinaryCodec é€šè¿‡

Day 4 (2/9):  âœ… å®ç° Server ç«¯æ ¸å¿ƒ
              - ServerTransport: Accept å¾ªç¯ + per-connection goroutine
              - æœåŠ¡æ³¨å†Œè¡¨: map[string]reflect.Value (ServiceMethod â†’ å‡½æ•°)
              - é€šè¿‡åå°„è°ƒç”¨æ³¨å†Œçš„æœåŠ¡å‡½æ•°
              ğŸ¯ äº§å‡º: Server èƒ½å¯åŠ¨å¹¶æ³¨å†ŒæœåŠ¡

Day 5 (2/10): âœ… å®ç° Client ç«¯æ ¸å¿ƒ
              - åŒæ­¥è°ƒç”¨: client.Call("Service.Method", args, &reply)
              - å‘é€è¯·æ±‚ï¼Œé˜»å¡ç­‰å¾…å“åº”
              ğŸ¯ é‡Œç¨‹ç¢‘: âœ… ç¬¬ä¸€æ¬¡å®Œæ•´ RPC è°ƒç”¨è·‘é€šï¼
              (client â†’ server â†’ åå°„è°ƒç”¨ â†’ è¿”å›ç»“æœ)

Day 6 (2/11): âœ… å®ç°è¿æ¥æ±  (ConnPool)
              - Get/Put/Close
              - åŸºæœ¬çš„è¿æ¥ä¸Šé™æ§åˆ¶
              ğŸ“ å†™ benchmark: æœ‰è¿æ¥æ±  vs æ— è¿æ¥æ± çš„ QPS å¯¹æ¯” (å¾…è¡¥)
              ğŸ¯ äº§å‡º: ConnPool å•å…ƒæµ‹è¯•é€šè¿‡

Day 7 (2/12): âœ… å®ç°å¤šè·¯å¤ç”¨
              - Client: atomic seq, pending map, recvLoop
              - å‘é€é”ä¿è¯å¸§å®Œæ•´æ€§
              ğŸ¯ äº§å‡º: å•è¿æ¥ä¸Šå¹¶å‘ 50 ä¸ªè¯·æ±‚å…¨éƒ¨æ­£ç¡®è¿”å›

Day 8 (2/13): âœ… å¤šè·¯å¤ç”¨ Bug ä¿®å¤ (sending.Lock èŒƒå›´æ‰©å¤§é˜²æ­¢å¸§äº¤é”™)
              âœ… å¼‚å¸¸å¤„ç†: è¿æ¥æ–­å¼€æ—¶ closeAllPending å…³é—­æ‰€æœ‰ pending è¯·æ±‚
              ğŸ¯ é‡Œç¨‹ç¢‘: âœ… ä¼ è¾“å±‚å®Œæˆï¼Œæ”¯æŒè¿æ¥æ±  + å¤šè·¯å¤ç”¨

Day 9 (2/14): âœ… å®‰è£…å¹¶å¯åŠ¨ etcd (Docker)
              âœ… å®ç° EtcdRegistry: Register, Deregister, Discover, Watch
              âœ… å†™å•å…ƒæµ‹è¯• (ç”¨ Docker etcd æµ‹è¯•)
              ğŸ¯ äº§å‡º: æœåŠ¡æ³¨å†Œåèƒ½è¢«å‘ç°ï¼Œä¸‹çº¿å Watch èƒ½æ„ŸçŸ¥

Day 10 (2/15): âœ… å®ç°ä¸‰ç§è´Ÿè½½å‡è¡¡: RoundRobin, WeightedRandom, ConsistentHash
               ğŸ“ å°† Registry + LB é›†æˆåˆ° Client (å¾…åš)
               ğŸ“ Client æ”¹é€ : è‡ªåŠ¨å‘ç° â†’ é€‰æ‹©å®ä¾‹ â†’ å»ºè¿/å¤ç”¨ (å¾…åš)
               ğŸ¯ äº§å‡º: ä¸‰ç§è´Ÿè½½å‡è¡¡å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡

Day 11 (2/16): ğŸ“ å®ç°ä¸­é—´ä»¶é“¾: Chain å‡½æ•°
               ğŸ“ å®ç° TimeoutMiddleware
               ğŸ“ å®ç° RateLimitMiddleware (ä»¤ç‰Œæ¡¶)
               ğŸ“ å®ç° LoggingMiddleware
               ğŸ¯ äº§å‡º: ä¸­é—´ä»¶èƒ½æ­£ç¡®æ‰§è¡Œå‰ç½®/åç½®é€»è¾‘

Day 12 (2/17): ğŸ“ ä¼˜é›…å…³é—­ (Graceful Shutdown)
               ğŸ“ å¿ƒè·³ä¿æ´»æœºåˆ¶
               ğŸ“ æ•´ä½“è”è°ƒ: å¯åŠ¨ etcd + å¤šä¸ª Server + Client ä¸­é—´ä»¶ + è´Ÿè½½å‡è¡¡
               ğŸ¯ äº§å‡º: å®Œæ•´ Demo èƒ½è·‘é€š

Day 13 (2/18): ğŸ“ Benchmark: å’Œ gRPC å¯¹æ¯” QPS/å»¶è¿Ÿ/å†…å­˜
               ğŸ“ å†™ README (æ¶æ„å›¾ã€è®¾è®¡å†³ç­–ã€æ€§èƒ½æ•°æ®)
               ğŸ“ å†™ examples/ ç›®å½•çš„ä½¿ç”¨ç¤ºä¾‹
               ğŸ¯ é‡Œç¨‹ç¢‘: âœ… Mini-RPC å®Œæˆï¼Œå¯ä»¥å†™è¿›ç®€å†ï¼
```

### Phase 2: GoChat IM ç³»ç»Ÿ (Day 14 ~ Day 25)

```
Day 14 (2/19): ğŸ“ é¡¹ç›®éª¨æ¶æ­å»º
               ğŸ“ WebSocket Gateway å±‚ (ç”¨ gorilla/websocket)
               ğŸ“ ç”¨æˆ·è¿æ¥ç®¡ç† (ConnManager: map[userID]*websocket.Conn)
               ğŸ“ ç®€å•è®¤è¯ (JWT)
               ğŸ¯ äº§å‡º: å®¢æˆ·ç«¯èƒ½é€šè¿‡ WebSocket è¿ä¸Š Gateway

Day 15 (2/20): ğŸ“ å•èŠæ¶ˆæ¯é€šè·¯
               - Client A â†’ Gateway â†’ è·¯ç”±åˆ° Client B çš„è¿æ¥ â†’ æ¨é€
               ğŸ“ æ¶ˆæ¯ç»“æ„ä½“å®šä¹‰ (Message, ChatMessage)
               ğŸ¯ é‡Œç¨‹ç¢‘: âœ… ä¸¤ä¸ªå®¢æˆ·ç«¯èƒ½äº’å‘æ¶ˆæ¯ï¼

Day 16 (2/21): ğŸ“ Snowflake æ¶ˆæ¯ ID ç”Ÿæˆå™¨
               ğŸ“ ACK æœºåˆ¶: å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯åå› ACK
               ğŸ“ è¶…æ—¶é‡å‘: æœªæ”¶åˆ° ACK çš„æ¶ˆæ¯é‡æ–°æ¨é€
               ğŸ¯ äº§å‡º: æ¶ˆæ¯å¯é æŠ•é€’ï¼ˆAt Least Onceï¼‰

Day 17 (2/22): ğŸ“ ç¦»çº¿æ¶ˆæ¯
               - ç”¨æˆ·ä¸åœ¨çº¿ â†’ æ¶ˆæ¯å­˜å…¥ Redis List
               - ç”¨æˆ·ä¸Šçº¿ â†’ æ‹‰å–ç¦»çº¿æ¶ˆæ¯ â†’ æ¨é€ â†’ æ¸…é™¤
               ğŸ“ æ¶ˆæ¯æŒä¹…åŒ–: MySQL å­˜å‚¨å†å²æ¶ˆæ¯
               ğŸ¯ äº§å‡º: ç¦»çº¿æ¶ˆæ¯ä¸ä¸¢å¤±

Day 18 (2/23): ğŸ“ å¤š Gateway å®ä¾‹æ”¯æŒ
               - Redis Pub/Sub åšè·¨èŠ‚ç‚¹æ¶ˆæ¯è½¬å‘
               - ç”¨æˆ·-Gateway è·¯ç”±è¡¨ (Redis Hash)
               - æ¶ˆæ¯è·¯ç”±: æŸ¥è·¯ç”±è¡¨ â†’ å‘åˆ°å¯¹åº” Gateway çš„ channel
               ğŸ¯ é‡Œç¨‹ç¢‘: âœ… å¯åŠ¨ 2 ä¸ª Gatewayï¼Œè·¨èŠ‚ç‚¹æ¶ˆæ¯èƒ½é€è¾¾

Day 19 (2/24): ğŸ“ ç¾¤èŠåŠŸèƒ½
               - ç¾¤æˆå‘˜åˆ—è¡¨ (MySQL + Redis ç¼“å­˜)
               - å†™æ‰©æ•£: ç»™ç¾¤é‡Œæ¯ä¸ªæˆå‘˜éƒ½å‘ä¸€æ¡æ¶ˆæ¯
               - ç¾¤æ¶ˆæ¯ ACK + ç¦»çº¿å­˜å‚¨
               ğŸ¯ äº§å‡º: ç¾¤èŠæ¶ˆæ¯èƒ½å‘é€å’Œæ¥æ”¶

Day 20 (2/25): ğŸ“ æ¶ˆæ¯å­˜å‚¨ä¼˜åŒ–
               - æœ€è¿‘ N æ¡æ¶ˆæ¯èµ° Redis (ZSet, score=æ¶ˆæ¯ID)
               - æ›´æ—©çš„æ¶ˆæ¯èµ° MySQL
               - æ¶ˆæ¯æ‹‰å–æ¥å£: æŒ‰æ¶ˆæ¯ ID åˆ†é¡µ
               ğŸ¯ äº§å‡º: å†å²æ¶ˆæ¯æ‹‰å–åŠŸèƒ½

Day 21-22 (2/26-27): ğŸ“ æ•´ä½“è”è°ƒ + Bug ä¿®å¤
                      ğŸ“ å‹æµ‹ (æ¨¡æ‹Ÿ 1000 å¹¶å‘è¿æ¥)
                      ğŸ“ pprof æ€§èƒ½åˆ†æï¼Œæ‰¾ç“¶é¢ˆ
                      ğŸ¯ äº§å‡º: ç³»ç»Ÿç¨³å®šè¿è¡Œ

Day 23-24 (2/28-3/1): ğŸ“ å†™ç®€å•çš„ Web UI (å¯é€‰ï¼Œç”¨ HTML+JS å³å¯)
                       ğŸ“ Docker Compose ä¸€é”®å¯åŠ¨ (Gateway + MySQL + Redis + etcd)
                       ğŸ“ å†™ README (æ¶æ„å›¾ã€è®¾è®¡å†³ç­–)
                       ğŸ¯ äº§å‡º: é¡¹ç›®å¯ä»¥ demo æ¼”ç¤º

Day 25 (3/2):  ğŸ“ ç®€å†æªè¾æ‰“ç£¨
               ğŸ“ å‡†å¤‡æ¯ä¸ªæ¨¡å—çš„é¢è¯•å›ç­” (è§ç¬¬ 11 ç« )
               ğŸ“ å¤ç›˜ä¸¤ä¸ªé¡¹ç›®çš„æ ¸å¿ƒè®¾è®¡å†³ç­–
               ğŸ¯ é‡Œç¨‹ç¢‘: âœ… GoChat å®Œæˆï¼Œç®€å†å°±ç»ªï¼
```

### ç¼“å†²ä¸é£é™©æ§åˆ¶

```
3/3 (å…ƒå®µèŠ‚) ä½œä¸ºç¼“å†²æ—¥:
  - å¦‚æœæå‰å®Œæˆ: åšé¢å¤–ä¼˜åŒ–
  - å¦‚æœå»¶æœŸ: ç”¨è¿™å¤©è¡¥é½

å¦‚æœ Phase 1 åˆ° Day 13 è¿˜æ²¡å®Œæˆ:
  ç æ‰ä¸­é—´ä»¶é“¾ (Day 11 å†…å®¹)ï¼ŒæŠŠæ—¶é—´ç•™ç»™ GoChat
  ä¸­é—´ä»¶å¯ä»¥åç»­è¡¥ï¼Œä¸¤ä¸ªé¡¹ç›®éƒ½å®Œæˆæ›´é‡è¦

å¦‚æœ GoChat æ¥ä¸åŠ:
  ç æ‰ç¾¤èŠ (Day 19) å’Œæ¶ˆæ¯å­˜å‚¨ä¼˜åŒ– (Day 20)
  èšç„¦: å•èŠ + å¯é æŠ•é€’ + å¤šèŠ‚ç‚¹ = å·²ç»è¶³å¤Ÿä¸Šç®€å†
```

---

## 10. é¡¹ç›®ç›®å½•ç»“æ„

### Mini-RPC

```
mini-rpc/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â””â”€â”€ main.go          # ç¤ºä¾‹ Server å¯åŠ¨å…¥å£
â”‚   â””â”€â”€ client/
â”‚       â””â”€â”€ main.go          # ç¤ºä¾‹ Client å¯åŠ¨å…¥å£
â”œâ”€â”€ protocol/
â”‚   â”œâ”€â”€ protocol.go          # å¸§å¤´ç¼–è§£ç 
â”‚   â””â”€â”€ protocol_test.go
â”œâ”€â”€ codec/
â”‚   â”œâ”€â”€ codec.go             # Codec æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ json_codec.go        # JSON å®ç°
â”‚   â”œâ”€â”€ binary_codec.go      # äºŒè¿›åˆ¶å®ç°
â”‚   â””â”€â”€ codec_test.go
â”œâ”€â”€ message/
â”‚   â””â”€â”€ message.go           # Request, Response ç»“æ„ä½“
â”œâ”€â”€ transport/
â”‚   â”œâ”€â”€ pool.go              # è¿æ¥æ± 
â”‚   â”œâ”€â”€ client_transport.go  # å®¢æˆ·ç«¯ä¼ è¾“å±‚ (å¤šè·¯å¤ç”¨)
â”‚   â”œâ”€â”€ server_transport.go  # æœåŠ¡ç«¯ä¼ è¾“å±‚
â”‚   â””â”€â”€ transport_test.go
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ server.go            # Server æ ¸å¿ƒ (æ³¨å†ŒæœåŠ¡ã€å¤„ç†è¯·æ±‚)
â”‚   â””â”€â”€ service.go           # æœåŠ¡æ³¨å†Œè¡¨ (åå°„)
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ client.go            # Client æ ¸å¿ƒ (åŒæ­¥/å¼‚æ­¥è°ƒç”¨)
â”‚   â””â”€â”€ call.go              # Call ç»“æ„ä½“ (ä»£è¡¨ä¸€æ¬¡ RPC è°ƒç”¨)
â”œâ”€â”€ registry/
â”‚   â”œâ”€â”€ registry.go          # Registry æ¥å£
â”‚   â”œâ”€â”€ etcd_registry.go     # etcd å®ç°
â”‚   â””â”€â”€ registry_test.go
â”œâ”€â”€ loadbalance/
â”‚   â”œâ”€â”€ balancer.go          # Balancer æ¥å£
â”‚   â”œâ”€â”€ roundrobin.go
â”‚   â”œâ”€â”€ weighted_random.go
â”‚   â”œâ”€â”€ consistent_hash.go
â”‚   â””â”€â”€ balancer_test.go
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ middleware.go         # Chain å‡½æ•°
â”‚   â”œâ”€â”€ timeout.go
â”‚   â”œâ”€â”€ ratelimit.go
â”‚   â””â”€â”€ logging.go
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ helloworld/          # æœ€ç®€ç¤ºä¾‹
â”‚   â””â”€â”€ features/            # å±•ç¤ºå„ä¸ªç‰¹æ€§çš„ç¤ºä¾‹
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ Makefile
â””â”€â”€ README.md
```

### GoChat

```
gochat/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ gateway/
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ client/
â”‚       â””â”€â”€ main.go          # ç®€å•å‘½ä»¤è¡Œå®¢æˆ·ç«¯
â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ gateway.go           # WebSocket ç½‘å…³
â”‚   â”œâ”€â”€ conn_manager.go      # è¿æ¥ç®¡ç†
â”‚   â””â”€â”€ router.go            # è·¨èŠ‚ç‚¹æ¶ˆæ¯è·¯ç”±
â”œâ”€â”€ message/
â”‚   â”œâ”€â”€ message.go           # æ¶ˆæ¯ç»“æ„ä½“
â”‚   â””â”€â”€ snowflake.go         # æ¶ˆæ¯ ID ç”Ÿæˆ
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ chat_service.go      # å•èŠ/ç¾¤èŠé€»è¾‘
â”‚   â”œâ”€â”€ offline_service.go   # ç¦»çº¿æ¶ˆæ¯å¤„ç†
â”‚   â”œâ”€â”€ group_service.go     # ç¾¤ç»„ç®¡ç†
â”‚   â””â”€â”€ ack_service.go       # ACK + é‡å‘
â”œâ”€â”€ store/
â”‚   â”œâ”€â”€ redis_store.go       # Redis æ“ä½œå°è£…
â”‚   â””â”€â”€ mysql_store.go       # MySQL æ“ä½œå°è£…
â”œâ”€â”€ auth/
â”‚   â””â”€â”€ jwt.go               # JWT è®¤è¯
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.go
â”œâ”€â”€ docker-compose.yml       # ä¸€é”®å¯åŠ¨
â”œâ”€â”€ go.mod
â””â”€â”€ README.md
```

---

## 11. é¢è¯•é«˜é¢‘è¿½é—®ä¸å›ç­”è¦ç‚¹

### Mini-RPC ç›¸å…³

**Q1: ä½ çš„ RPC æ¡†æ¶å’Œ gRPC æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

```
è¦ç‚¹:
- gRPC åŸºäº HTTP/2 (è‡ªå¸¦å¤šè·¯å¤ç”¨ã€å¤´éƒ¨å‹ç¼©)ï¼Œæˆ‘ç”¨è‡ªå®šä¹‰ TCP åè®®
- gRPC ç”¨ Protobuf (éœ€è¦ IDL + ä»£ç ç”Ÿæˆ)ï¼Œæˆ‘æ”¯æŒ JSON + ç®€æ˜“äºŒè¿›åˆ¶
- gRPC åŠŸèƒ½å®Œæ•´ (Streamingã€æ‹¦æˆªå™¨ã€TLS)ï¼Œæˆ‘èšç„¦æ ¸å¿ƒé“¾è·¯
- æˆ‘çš„æ¡†æ¶æ€§èƒ½åœ¨ç®€å•åœºæ™¯ä¸‹æ¥è¿‘ gRPCï¼Œå› ä¸ºåè®®æ›´è½»é‡
- åšè¿™ä¸ªé¡¹ç›®çš„ç›®çš„æ˜¯ç†è§£ RPC åº•å±‚åŸç†ï¼Œä¸æ˜¯æ›¿ä»£ gRPC
```

**Q2: TCP ç²˜åŒ…æ€ä¹ˆè§£å†³çš„ï¼Ÿ**

```
è¦ç‚¹:
- TCP æ˜¯å­—èŠ‚æµåè®®ï¼Œä¸ä¿ç•™æ¶ˆæ¯è¾¹ç•Œ
- ä¸‰ç§è§£å†³æ–¹æ¡ˆ: å®šç•Œç¬¦ã€å®šé•¿æ¶ˆæ¯ã€é•¿åº¦å‰ç¼€
- æˆ‘ç”¨é•¿åº¦å‰ç¼€: 14 å­—èŠ‚å®šé•¿å¸§å¤´åŒ…å« BodyLength å­—æ®µ
- æ¥æ”¶æ–¹å…ˆè¯» 14 å­—èŠ‚æ‹¿åˆ°é•¿åº¦ï¼Œå†ç²¾ç¡®è¯»å–å¯¹åº”å­—èŠ‚
- ä¸ºä»€ä¹ˆä¸ç”¨å®šç•Œç¬¦: äºŒè¿›åˆ¶æ¶ˆæ¯ä½“å¯èƒ½åŒ…å«ä»»ä½•å­—èŠ‚ï¼Œä¼šè¯¯åˆ‡
```

**Q3: å¤šè·¯å¤ç”¨æ€ä¹ˆå®ç°çš„ï¼Ÿå…³é”®ç‚¹åœ¨å“ªï¼Ÿ**

```
è¦ç‚¹:
- æ¯ä¸ªè¯·æ±‚åˆ†é…å”¯ä¸€ Sequence ID (atomic è‡ªå¢)
- å‘é€: æŠŠè¯·æ±‚å’Œä¸€ä¸ª channel å­˜å…¥ pending map
- æ¥æ”¶: åå° goroutine å¾ªç¯è¯»å“åº”ï¼ŒæŒ‰ Seq ä» pending map å–å‡º channel å¹¶å‘é€
- å…³é”®ç‚¹: å†™å¿…é¡»åŠ é” (é¿å…å¸§äº¤é”™)ï¼Œè¯»ä¸ç”¨é” (å• goroutine)
- è¿æ¥æ–­å¼€æ—¶: éå† pending mapï¼Œç»™æ‰€æœ‰ channel å‘é”™è¯¯
```

**Q4: ä¸€è‡´æ€§å“ˆå¸Œä¸ºä»€ä¹ˆéœ€è¦è™šæ‹ŸèŠ‚ç‚¹ï¼Ÿ**

```
è¦ç‚¹:
- å®é™…èŠ‚ç‚¹å°‘æ—¶ï¼Œå“ˆå¸Œç¯ä¸Šåˆ†å¸ƒä¸å‡ï¼Œå¯¼è‡´æŸäº›èŠ‚ç‚¹æ‰¿æ‹…è¿‡å¤šè¯·æ±‚
- è™šæ‹ŸèŠ‚ç‚¹: æ¯ä¸ªçœŸå®èŠ‚ç‚¹æ˜ å°„ N ä¸ªè™šæ‹ŸèŠ‚ç‚¹ (æ¯”å¦‚ 150 ä¸ª)
- é€šè¿‡å¢åŠ èŠ‚ç‚¹æ•°é‡ï¼Œç»Ÿè®¡ä¸Šæ›´è¶‹è¿‘å‡åŒ€åˆ†å¸ƒ
- èŠ‚ç‚¹ä¸‹çº¿æ—¶: å®ƒçš„è™šæ‹ŸèŠ‚ç‚¹åˆ é™¤ï¼Œæµé‡åˆ†æ•£åˆ°ç›¸é‚»å¤šä¸ªèŠ‚ç‚¹ï¼ˆè€Œéé›†ä¸­åˆ°ä¸€ä¸ªï¼‰
```

**Q5: ä»¤ç‰Œæ¡¶å’Œæ¼æ¡¶æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

```
è¦ç‚¹:
- æ¼æ¡¶: åŒ€é€Ÿæµå‡ºï¼Œé€‚åˆå¹³æ»‘æµé‡ (å‰Šå³°)
- ä»¤ç‰Œæ¡¶: æŒ‰é€Ÿç‡æ”¾ä»¤ç‰Œï¼Œå…è®¸ä¸€å®šçªå‘ (burst)
- æˆ‘ç”¨ä»¤ç‰Œæ¡¶: å…è®¸çŸ­æ—¶é—´çªå‘æµé‡ï¼Œæ›´é€‚åˆ RPC åœºæ™¯
- Go æ ‡å‡†åº“ golang.org/x/time/rate å°±æ˜¯ä»¤ç‰Œæ¡¶å®ç°
```

### GoChat ç›¸å…³

**Q6: æ¶ˆæ¯æ€ä¹ˆä¿è¯ä¸ä¸¢ï¼Ÿ**

```
è¦ç‚¹:
- At Least Once: å‘é€ + ACK + è¶…æ—¶é‡å‘
- å®¢æˆ·ç«¯å»é‡: ç”¨æ¶ˆæ¯ ID (Snowflake) å»é‡
- ç¦»çº¿æ¶ˆæ¯: ç”¨æˆ·ä¸åœ¨çº¿æ—¶å­˜å…¥ Redis Listï¼Œä¸Šçº¿åæ‹‰å–
- æŒä¹…åŒ–: MySQL å­˜æ‰€æœ‰æ¶ˆæ¯ï¼Œå³ä½¿ Redis æŒ‚äº†ä¹Ÿèƒ½æ¢å¤
- ä¸åš Exactly Once: åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å‡ ä¹ä¸å¯èƒ½ï¼Œä»£ä»·å¤ªå¤§
```

**Q7: å¤š Gateway èŠ‚ç‚¹ï¼Œæ¶ˆæ¯æ€ä¹ˆè·¯ç”±ï¼Ÿ**

```
è¦ç‚¹:
- ç”¨æˆ·è¿æ¥åˆ°æŸä¸ª Gateway åï¼Œåœ¨ Redis ä¸­è®°å½•è·¯ç”±è¡¨: userID â†’ gatewayID
- å‘æ¶ˆæ¯æ—¶: æŸ¥è·¯ç”±è¡¨ â†’ å¦‚æœç›®æ ‡ç”¨æˆ·åœ¨æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥æ¨é€
                      â†’ å¦‚æœåœ¨å…¶ä»–èŠ‚ç‚¹ï¼Œé€šè¿‡ Redis Pub/Sub è½¬å‘
- Pub/Sub channel: æ¯ä¸ª Gateway ç›‘å¬ "gateway:{id}" channel
- ç”¨æˆ·æ–­å¼€: åˆ é™¤è·¯ç”±è¡¨è®°å½•
```

**Q8: Snowflake ç®—æ³•æ€ä¹ˆå·¥ä½œçš„ï¼Ÿæ—¶é’Ÿå›æ‹¨æ€ä¹ˆåŠï¼Ÿ**

```
è¦ç‚¹:
- 64 bit = 1 bit ç¬¦å· + 41 bit æ—¶é—´æˆ³ + 10 bit æœºå™¨ID + 12 bit åºåˆ—å·
- 41 bit æ—¶é—´æˆ³: å¯ä»¥ç”¨çº¦ 69 å¹´ (æ¯«ç§’çº§)
- 12 bit åºåˆ—å·: åŒä¸€æ¯«ç§’å†…æœ€å¤š 4096 ä¸ª ID
- æ—¶é’Ÿå›æ‹¨: ç®€å•æ–¹æ¡ˆæ˜¯æ‹’ç»ç”Ÿæˆ ID å¹¶æŠ¥é”™ï¼Œç­‰æ—¶é—´è¿½ä¸Š
- æ›´å¥½æ–¹æ¡ˆ: ç”¨æœ€åä¸€æ¬¡çš„æ—¶é—´æˆ³ + åºåˆ—å·ç»§ç»­ç”Ÿæˆï¼Œä¸ä¾èµ–ç³»ç»Ÿæ—¶é’Ÿ
```

**Q9: ä¸‡äººç¾¤å‘ä¸€æ¡æ¶ˆæ¯ï¼Œå†™æ‰©æ•£è¦å†™å¤šå°‘æ¬¡ï¼Ÿæ€ä¹ˆä¼˜åŒ–ï¼Ÿ**

```
è¦ç‚¹:
- å†™æ‰©æ•£: æ¯ä¸ªæˆå‘˜çš„æ”¶ä»¶ç®±éƒ½å†™ä¸€æ¡ â†’ 10000 æ¬¡å†™æ“ä½œ
- å¤§ç¾¤ä¼˜åŒ–: æ”¹ç”¨è¯»æ‰©æ•£ â€” åªå†™ä¸€æ¬¡åˆ°ç¾¤çš„æ¶ˆæ¯æµï¼Œæˆå‘˜æ‹‰å–æ—¶å†è¯»
- æˆ‘çš„å®ç°: å°ç¾¤ (< 200äºº) ç”¨å†™æ‰©æ•£ï¼Œå¤§ç¾¤ç”¨è¯»æ‰©æ•£
- é¢è¯•åŠ åˆ†: æåˆ°å¾®ä¿¡ç”¨çš„æ˜¯"å†™æ‰©æ•£ + å­˜å‚¨å±‚ä¼˜åŒ–"ï¼Œä¸åŒäº§å“ç­–ç•¥ä¸åŒ
```

---

## 12. Benchmark è®¡åˆ’

### Mini-RPC Benchmark

```go
// benchmark/bench_test.go

// åœºæ™¯1: å•è¿æ¥ä¸²è¡Œè°ƒç”¨ QPS
func BenchmarkSerial(b *testing.B) { ... }

// åœºæ™¯2: å•è¿æ¥å¤šè·¯å¤ç”¨å¹¶å‘è°ƒç”¨ QPS
func BenchmarkMultiplex(b *testing.B) { ... }

// åœºæ™¯3: è¿æ¥æ±  + å¤šè·¯å¤ç”¨å¹¶å‘è°ƒç”¨ QPS
func BenchmarkPoolMultiplex(b *testing.B) { ... }

// åœºæ™¯4: å’Œæ ‡å‡† gRPC å¯¹æ¯”
func BenchmarkGRPC(b *testing.B) { ... }

// åœºæ™¯5: JSON vs Binary åºåˆ—åŒ–æ€§èƒ½
func BenchmarkJSONCodec(b *testing.B) { ... }
func BenchmarkBinaryCodec(b *testing.B) { ... }
```

### æœŸæœ›æ•°æ®ï¼ˆå‚è€ƒé‡çº§ï¼‰

```
                      Mini-RPC (JSON)   Mini-RPC (Binary)   gRPC (Protobuf)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä¸²è¡Œ QPS              ~15,000           ~25,000             ~20,000
å¤šè·¯å¤ç”¨ QPS           ~80,000           ~120,000            ~100,000
P99 å»¶è¿Ÿ (us)         ~200              ~120                ~150
```

(å…·ä½“æ•°æ®å–å†³äºæœºå™¨é…ç½®ï¼Œé‡è¦çš„æ˜¯ç›¸å¯¹æ¯”è¾ƒå’Œè¶‹åŠ¿)

---

## 13. GoChat IM ç³»ç»Ÿè®¾è®¡ï¼ˆPhase 2ï¼‰

### 13.1 æ¶æ„å¤§å›¾

```
                              GoChat Architecture
                              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Client A          Client B                        Client C
  (WebSocket)       (WebSocket)                     (WebSocket)
      â”‚                 â”‚                               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
               â”‚                                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
        â”‚  Gateway 1  â”‚                        â”‚   Gateway 2   â”‚
        â”‚ (WS Server) â”‚                        â”‚  (WS Server)  â”‚
        â”‚ ConnManager â”‚                        â”‚  ConnManager  â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                        â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         Redis          â”‚  (è·¨èŠ‚ç‚¹æ¶ˆæ¯è½¬å‘)
                    â”‚ - Pub/Sub              â”‚  (user -> gateway æ˜ å°„)
                    â”‚ - Routing Table        â”‚
                    â”‚ - Offline Queue(List)  â”‚
                    â”‚ - Hot Cache            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚      MySQL     â”‚
                        â”‚ - Users        â”‚
                        â”‚ - Messages     â”‚
                        â”‚ - Groups       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2 æ ¸å¿ƒæ¶ˆæ¯ç»“æ„

```go
type Message struct {
    ID        int64     `json:"id"`         // Snowflake ç”Ÿæˆ
    Type      MsgType   `json:"type"`       // å•èŠ/ç¾¤èŠ/ACK/ç³»ç»Ÿæ¶ˆæ¯
    From      string    `json:"from"`       // å‘é€è€… ID
    To        string    `json:"to"`         // æ¥æ”¶è€… ID æˆ–ç¾¤ ID
    Content   string    `json:"content"`
    Timestamp int64     `json:"timestamp"`
    Seq       int64     `json:"seq"`        // å®¢æˆ·ç«¯æœ¬åœ°åºåˆ—å· (å»é‡ç”¨)
}

type MsgType int
const (
    MsgTypeChat     MsgType = 1  // å•èŠ
    MsgTypeGroup    MsgType = 2  // ç¾¤èŠ
    MsgTypeAck      MsgType = 3  // ACK
    MsgTypeSystem   MsgType = 4  // ç³»ç»Ÿé€šçŸ¥
)
```

### 13.3 æ¶ˆæ¯å¯é æŠ•é€’æµç¨‹

```
å‘é€æ–¹ A                Gateway              æ¥æ”¶æ–¹ B
   â”‚                        â”‚                          â”‚
   â”‚ 1. å‘é€æ¶ˆæ¯            â”‚                          â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
   â”‚                        â”‚ 2. ç”Ÿæˆæ¶ˆæ¯ ID           â”‚
   â”‚                        â”‚ 3. å­˜å…¥ MySQL            â”‚
   â”‚                        â”‚ 4. æ£€æŸ¥ B æ˜¯å¦åœ¨çº¿       â”‚
   â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ åœ¨çº¿: æ¨é€
   â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 5. ACK
   â”‚                        â”‚ 6. æ ‡è®°å·²é€è¾¾            â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 7. è¿”å›å‘é€æˆåŠŸ          â”‚
   â”‚                        â”‚                          â”‚
   â”‚                        â”‚ ä¸åœ¨çº¿: å†™å…¥ Redis List  â”‚
   â”‚                        â”‚ ... B ä¸Šçº¿åæ‹‰å–ç¦»çº¿ ... â”‚
   â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ 8. æ‹‰å–ç¦»çº¿æ¶ˆæ¯
   â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ ACK
   â”‚                        â”‚ 9. æ¸…é™¤ç¦»çº¿æ¶ˆæ¯          â”‚
```

### 13.4 MySQL è¡¨è®¾è®¡

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id VARCHAR(64) PRIMARY KEY,
    nickname VARCHAR(128),
    avatar VARCHAR(256),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ¶ˆæ¯è¡¨ (æŒ‰æœˆåˆ†è¡¨: messages_202602)
CREATE TABLE messages (
    id BIGINT PRIMARY KEY,          -- Snowflake ID
    msg_type TINYINT NOT NULL,
    from_user VARCHAR(64) NOT NULL,
    to_user VARCHAR(64) NOT NULL,   -- å•èŠæ˜¯ userIDï¼Œç¾¤èŠæ˜¯ groupID
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_to_user_id (to_user, id),  -- æ‹‰å–æŸäººæ¶ˆæ¯ç”¨
    INDEX idx_group_id (to_user, id)     -- æ‹‰å–ç¾¤æ¶ˆæ¯ç”¨
);

-- ç¾¤ç»„è¡¨
CREATE TABLE groups (
    id VARCHAR(64) PRIMARY KEY,
    name VARCHAR(128),
    owner VARCHAR(64),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç¾¤æˆå‘˜è¡¨
CREATE TABLE group_members (
    group_id VARCHAR(64),
    user_id VARCHAR(64),
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (group_id, user_id)
);
```

---

## 14. ç®€å†æªè¾å»ºè®®

### Mini-RPC æ¡†æ¶

```
Mini-RPC | Go, TCP, etcd | ç‹¬ç«‹å¼€å‘ | GitHub é“¾æ¥

â€¢ ä»é›¶å®ç°è½»é‡çº§ RPC æ¡†æ¶ï¼Œæ”¯æŒè‡ªå®šä¹‰äºŒè¿›åˆ¶åè®®ã€TCP è¿æ¥æ± å¤ç”¨å’Œ
  å•è¿æ¥å¤šè·¯å¤ç”¨ï¼Œå•è¿æ¥å¹¶å‘ QPS è¾¾åˆ° XX,000+

â€¢ è®¾è®¡ 14 å­—èŠ‚å®šé•¿å¸§å¤´åè®®è§£å†³ TCP ç²˜åŒ…é—®é¢˜ï¼Œæ”¯æŒ JSON / äºŒè¿›åˆ¶
  åŒç¼–è§£ç å™¨ï¼ŒäºŒè¿›åˆ¶æ¨¡å¼ä¸‹åºåˆ—åŒ–æ€§èƒ½è¾ƒ JSON æå‡çº¦ XX%

â€¢ åŸºäº etcd å®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼Œæ”¯æŒ TTL ç§Ÿçº¦ + Watch å®æ—¶æ„ŸçŸ¥
  å®ä¾‹ä¸Šä¸‹çº¿ï¼›é›†æˆ Round-Robinã€åŠ æƒéšæœºã€ä¸€è‡´æ€§å“ˆå¸Œä¸‰ç§è´Ÿè½½å‡è¡¡ç­–ç•¥

â€¢ å®ç°æ´‹è‘±æ¨¡å‹ä¸­é—´ä»¶é“¾ï¼Œå†…ç½®è¶…æ—¶æ§åˆ¶ã€ä»¤ç‰Œæ¡¶é™æµå’Œè¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
```

### GoChat IM ç³»ç»Ÿ

```
GoChat | Go, WebSocket, Redis, MySQL | ç‹¬ç«‹å¼€å‘ | GitHub é“¾æ¥

â€¢ è®¾è®¡å¹¶å®ç°æ”¯æŒå¤šèŠ‚ç‚¹éƒ¨ç½²çš„å³æ—¶é€šè®¯ç³»ç»Ÿï¼ŒåŸºäº WebSocket é•¿è¿æ¥ç½‘å…³
  æ”¯æŒå•èŠã€ç¾¤èŠï¼Œé€šè¿‡ Redis Pub/Sub å®ç°è·¨ Gateway æ¶ˆæ¯è·¯ç”±

â€¢ å®ç° ACK + è¶…æ—¶é‡å‘æœºåˆ¶ä¿è¯æ¶ˆæ¯ At Least Once æŠ•é€’ï¼Œç»“åˆ
  Snowflake ID å®ç°å®¢æˆ·ç«¯å»é‡ï¼Œç¦»çº¿æ¶ˆæ¯é€šè¿‡ Redis List æš‚å­˜

â€¢ è®¾è®¡æ¶ˆæ¯å­˜å‚¨åˆ†å±‚æ¶æ„: çƒ­æ•°æ® Redis ZSet ç¼“å­˜æœ€è¿‘ N æ¡ï¼Œ
  å†·æ•°æ®è½ç›˜ MySQLï¼Œæ”¯æŒåŸºäºæ¶ˆæ¯ ID çš„åˆ†é¡µæ‹‰å–

â€¢ ä½¿ç”¨ Docker Compose ä¸€é”®éƒ¨ç½²ï¼Œpprof å‹æµ‹ä¸‹æ”¯æŒ XX å¹¶å‘é•¿è¿æ¥
```

(XX å¤„åœ¨ benchmark åå¡«å…¥å®é™…æ•°æ®)

---

## é™„å½• A: å…³é”®ä¾èµ–

```
Mini-RPC:
  go.etcd.io/etcd/client/v3   # etcd å®¢æˆ·ç«¯
  golang.org/x/time/rate       # ä»¤ç‰Œæ¡¶é™æµ

GoChat:
  github.com/gorilla/websocket # WebSocket
  github.com/go-redis/redis/v8 # Redis å®¢æˆ·ç«¯
  github.com/go-sql-driver/mysql # MySQL é©±åŠ¨
  github.com/golang-jwt/jwt/v5  # JWT è®¤è¯
```

## é™„å½• B: æ¯å¤©å­¦ä¹ å‰é—®è‡ªå·±çš„ä¸‰ä¸ªé—®é¢˜

```
1. ä»Šå¤©è¿™ä¸ªæ¨¡å—è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚æœæ²¡æœ‰å®ƒä¼šæ€æ ·ï¼Ÿ
2. æœ‰å“ªäº›è®¾è®¡ tradeoffï¼Ÿæˆ‘é€‰äº†å“ªä¸ªæ–¹æ¡ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ
3. é¢è¯•å®˜ä¼šæ€ä¹ˆè¿½é—®è¿™ä¸ªæ¨¡å—ï¼Ÿæˆ‘æ€ä¹ˆå›ç­”ï¼Ÿ
```

---

> ğŸ“Œ **è¿™ä»½æ–‡æ¡£æ˜¯ä½ çš„"ä½œæˆ˜åœ°å›¾"ã€‚æ¯å¤©å¼€å§‹å‰å…ˆçœ‹å¯¹åº”ç« èŠ‚çš„è®¾è®¡ï¼Œå†™å®Œåå›æ¥å¯¹ç…§é¢è¯•è¿½é—®å‡†å¤‡å›ç­”ã€‚**
> **å¦‚æœåœ¨æ–°å¯¹è¯ä¸­ç»§ç»­è®¨è®ºï¼Œç›´æ¥æŠŠè¿™ä»½æ–‡æ¡£å‘ç»™æˆ‘ï¼Œæˆ‘å°±èƒ½æ— ç¼æ¥ä¸Šã€‚**
